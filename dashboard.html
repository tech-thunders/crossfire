<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="header.css" />
    <link rel="stylesheet" href="notification.css" />
    <link rel="stylesheet" href="dashboard-profile.css" />
    <title>ThunderTrack</title>
  </head>
  <body>
    <header>
      <nav>
        <div class="navbar">
          <div>
            <a href="dashboard.html"
              ><img
                src="images/crossfire-logo-transparent.png"
                alt="Crossfire Logo"
                class="logo"
            /></a>
          </div>
          <div class="navbar-links">
            <ul>
              <li>
                <a href="dashboard.html"
                  ><i class="bi bi-house-fill"></i> Dashboard</a
                >
              </li>
              <li>
                <a href="view-ncr.html"
                  ><i
                    class="bi bi-file-earmark-bar-graph-fill"
                    style="font-weight: 900"
                  ></i>
                  NCR Log</a
                >
              </li>
              <li id="create-ncr-menu">
                <a href="create-ncr.html"
                  ><i class="bi bi-file-earmark-plus-fill"></i> Create NCR</a
                >
              </li>
            </ul>
          </div>
          <div class="navbar-icons">
            <div
              onclick="closePopUp()"
              title="Notifications"
              class="navbar-notification"
            >
              <i id="notification-icon" class="bi bi-bell-fill"></i>
              <div id="notification-indicator" class="notification-indicator">
                4
              </div>
            </div>
            <!-- User Profile Dropdown -->
            <div
              class="navbar-profile"
              onclick="toggleProfileMenu()"
              title="Profile"
            >
              <i class="bi bi-person-circle"></i>
              <span id="userName">User</span>
              <i class="bi bi-chevron-down"></i>
            </div>

            <!-- Profile Dropdown Menu -->
            <div id="profilePopup" class="profile-popup hidden">
              <div class="profile-header">
                <i class="bi bi-person-circle profile-icon"></i>
                <div>
                  <h4 id="profileName">User Name</h4>
                  <p id="profileDepartment">Department</p>
                </div>
              </div>
              <div class="profile-menu">
                <a href="profile.html" class="profile-menu-item">
                  <i class="bi bi-person"></i> My Profile
                </a>
                <a href="setting-mock.html" class="profile-menu-item">
                  <i class="bi bi-gear"></i> Settings
                </a>
                <hr class="profile-divider" />
                <a
                  href="index.html"
                  class="profile-menu-item"
                  onclick="logout()"
                >
                  <i class="bi bi-box-arrow-right"></i> Logout
                </a>
              </div>
            </div>

            <div onclick="toggleMenu()" title="Menu" class="navbar-menu">
              <i id="menu-icon"></i>
            </div>
          </div>
          <div
            id="notificationPopup"
            title="Notifications"
            class="notification-popup hidden"
          >
            <!-- Notifications -->
            <div>
              <h3 class="notification-title">Notifications</h3>
              <p id="no-notifications" class="no-notifications">
                No notifications yet
              </p>
              <ul class="notification-list"></ul>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <main>
      <!-- Welcome Message Section -->
      <div id="wrapper" aria-label="Welocome Message">
        <div class="simple-welcome">
          <h2 id="welcomeMessage">Good morning, Michael!</h2>
          <p id="welcomeDate" class="welcome-date-text">
            Thursday, December 5, 2024
          </p>
        </div>
      </div>

      <div id="wrapper">
        <section>
          <div class="dashboard-summary">
            <h1>NCR Summary</h1>
            <div class="row">
              <div class="col m4 card">
                <div class="icon-circle card-blue">
                  <i class="bi bi-archive"></i>
                </div>
                <div>
                  <p>All NCRs</p>
                  <h3 id="total-ncr-summary">20</h3>
                </div>
              </div>
              <div class="col m4 card">
                <div class="icon-circle card-green">
                  <i class="bi bi-check2-circle"></i>
                </div>
                <div>
                  <p>Active NCRs</p>
                  <h3 id="active-ncr">12</h3>
                </div>
              </div>
              <div class="col m4 card">
                <div class="icon-circle card-red">
                  <i class="bi bi-x-circle"></i>
                </div>
                <div>
                  <p>Closed NCRs</p>
                  <h3>8</h3>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <div id="wrapper">
        <h1>Recent NCRs</h1>
        <div class="container">
          <div class="filter-buttons">
            <button class="filter-btn active" data-status="all">All NCR</button>
            <button class="filter-btn" data-status="Active">Active</button>
            <button class="filter-btn" data-status="Closed">Closed</button>
          </div>

          <input
            type="text"
            id="search"
            placeholder="Filter results by NCR No, Supplier Name, Date or Status..."
          />

          <div class="table-container">
            <table id="ncrTable">
              <thead>
                <tr>
                  <th onclick="sortTable(0)">
                    NCR No. <i class="bi bi-arrow-down-up"></i>
                  </th>
                  <th onclick="sortTable(2)">
                    Date Created <i class="bi bi-arrow-down-up"></i>
                  </th>
                  <th onclick="sortTable(3)">
                    Supplier Name <i class="bi bi-arrow-down-up"></i>
                  </th>
                  <th onclick="sortTable(1)">
                    Current Status <i class="bi bi-arrow-down-up"></i>
                  </th>
                  <th colspan="2">Action</th>
                </tr>
              </thead>
              <tbody id="ncrTableBody"></tbody>
            </table>
          </div>

          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </main>

    <footer>&copy;Tech Thunders 2025</footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="scripts/data-manager.js"></script>
    <script src="scripts/script.js"></script>
    <script src="scripts/notifications.js"></script>
    <script src="scripts/user-conditions.js"></script>
    <script>
      // Load current user from localStorage
      let currentUser = null;

      function loadCurrentUser() {
        const userData = localStorage.getItem("currentUser");
        if (userData) {
          try {
            currentUser = JSON.parse(userData);
            updateUserInterface();
          } catch (e) {
            console.error("Error loading user data:", e);
            window.location.href = "index.html";
          }
        } else {
          window.location.href = "index.html";
        }
      }

      function updateUserInterface() {
        if (!currentUser) return;

        document.getElementById("userName").textContent = currentUser.firstName;
        document.getElementById(
          "profileName"
        ).textContent = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById("profileDepartment").textContent =
          currentUser.department;

        const hour = new Date().getHours();
        let greeting = "Welcome back";
        if (hour < 12) greeting = "Good morning";
        else if (hour < 18) greeting = "Good afternoon";
        else greeting = "Good evening";

        document.getElementById(
          "welcomeMessage"
        ).textContent = `${greeting}, ${currentUser.firstName}!`;

        const today = new Date();
        const dateOptions = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };
        document.getElementById("welcomeDate").textContent =
          today.toLocaleDateString("en-US", dateOptions);
      }

      function toggleProfileMenu() {
        const popup = document.getElementById("profilePopup");
        const notificationPopup = document.getElementById("notificationPopup");
        notificationPopup.classList.add("hidden");
        popup.classList.toggle("hidden");
      }

      function logout() {
        localStorage.removeItem("currentUser");
        window.location.href = "index.html";
      }

      document.addEventListener("click", function (event) {
        const profilePopup = document.getElementById("profilePopup");
        const profileButton = document.querySelector(".navbar-profile");
        if (
          !profileButton.contains(event.target) &&
          !profilePopup.contains(event.target)
        ) {
          profilePopup.classList.add("hidden");
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        loadCurrentUser();
      });

      // NCR Data Management
      let ncrData = [];
      let filteredData = [];
      let currentPage = 1;
      const rowsPerPage = 5;
      let sortColumn = -1;
      let sortAsc = true;

      // Load NCR data
      fetch("data/logData.json")
        .then((response) => response.json())
        .then((data) => {
          const records = localStorage.getItem("ncr_records");
          // ncrData = records ? records : data;
          if (records) {
            try {
              ncrData = JSON.parse(records); // ← FIX
            } catch (e) {
              console.error("Invalid NCR localStorage data – resetting.", e);
              ncrData = data;
            }
          } else {
            ncrData = data; // fallback to JSON file
          }
          filteredData = [...ncrData];

          renderTable();
        })
        .catch((error) => console.error("Error loading NCR data:", error));

      function renderTable() {
        const tableBody = document.getElementById("ncrTableBody");
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredData.slice(start, end);

        tableBody.innerHTML = "";

        pageData.forEach((item) => {
          const date = new Date(item.dateCreated);
          const formattedDate = date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });

          const row = `
            <tr>
              <td>${item.ncrNumber}</td>
             
              <td>${formattedDate}</td>
              <td>${item.supplierName}</td>
               <td>${item.status}</td>
              <td><a href="detailedViewNCR.html?ncr=${item.ncrNumber}" class="view-ncr" onClick="selectedLog('${item.ncrNumber}')">View</a></td>
              <td><a href="edit-ncr.html" onClick="selectedLog('${item.ncrNumber}')" class="view-ncr">Edit</a></td>
            </tr>
          `;
          tableBody.innerHTML += row;
        });

        renderPagination();
      }

      function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
          pagination.innerHTML += `<button class="${
            i === currentPage ? "active" : ""
          }" onclick="goToPage(${i})">${i}</button>`;
        }
      }

      function goToPage(page) {
        currentPage = page;
        renderTable();
      }

      // Search
      document.getElementById("search").addEventListener("input", function () {
        const query = this.value.toLowerCase();
        filteredData = ncrData.filter(
          (item) =>
            item.ncrNumber.toLowerCase().includes(query) ||
            item.currentStage.toLowerCase().includes(query) ||
            item.supplierName.toLowerCase().includes(query) ||
            new Date(item.dateCreated)
              .toLocaleDateString("en-US")
              .toLowerCase()
              .includes(query)
        );
        currentPage = 1;
        renderTable();
      });

      // Filter buttons
      document.querySelectorAll(".filter-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const status = btn.dataset.status;
          filteredData =
            status === "all"
              ? [...ncrData]
              : ncrData.filter((item) => item.status === status);
          currentPage = 1;
          renderTable();
        })
      );

      // Sorting
      function sortTable(colIndex) {
        const keys = [
          "ncrNumber",
          "currentStage",
          "dateCreated",
          "supplierName",
        ];
        if (sortColumn === colIndex) sortAsc = !sortAsc;
        else sortAsc = true;
        sortColumn = colIndex;

        filteredData.sort((a, b) => {
          const valA = a[keys[colIndex]].toLowerCase();
          const valB = b[keys[colIndex]].toLowerCase();
          return (valA > valB ? 1 : valA < valB ? -1 : 0) * (sortAsc ? 1 : -1);
        });
        renderTable();
      }
    </script>
  </body>
</html>
