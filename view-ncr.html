<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="header.css" />
    <link rel="stylesheet" href="notification.css" />
    <link rel="stylesheet" href="dashboard-profile.css" />
    <link rel="stylesheet" href="breadcrumbs.css" />
    
    <title>NCR Logs</title>
    <style>
      a {
        text-decoration: none;
      }

      body {
        background-color: #fff;
        font-family: "Poppins", sans-serif;
        font-size: 16px;
        margin: 0;
        padding: 0;
      }

      #wrapper {
        padding: 20px 0px;
        width: 100%;
        max-width: 1420px;
        margin: 0 auto;
      }

      /* Page Content */
      h1 {
        text-align: center;
        color: #333;
        background-color: #e0e0e0;
        padding: 20px;
        max-width: 93%;
        margin: auto;
      }

      .container {
        width: 100%;
        background-color: white;
        margin: 30px auto;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .filter-buttons {
        text-align: center;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      .filter-buttons button {
        background-color: #e0e0e0;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
      }

      .filter-buttons button.active {
        background-color: #2f6ea3;
        color: #fff;
      }

      input {
        width: 60%;
        padding: 10px;
        margin: 20px auto;
        display: block;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      /* Table Responsiveness */
      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        border-radius: 8px;
        min-width: 600px;
      }

      th,
      td {
        padding: 15px;
        text-align: left;
        color: #333;
      }

      th {
        background-color: #e0e0e0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
      }

      tr:nth-child(odd) {
        background-color: #f7f7f7;
      }

      tr:hover {
        background-color: #e0f0ff;
        transition: 0.3s;
      }

      .view-ncr {
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        color: #fff;
        background-color: #2f6ea3;
        margin-right: 40px;
      }
      td.action-cell {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 4px;
        margin: 6px auto;
      }

      .view-ncr:hover {
        background-color: #4a8bc0;
      }

      .generate-pdf-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        color: white;
        background-color: #6b7280;
        font-size: 16px;
      }

      .generate-pdf-btn:hover {
        background-color: #4b5563;
      }

      .pagination {
        text-align: center;
        margin-top: 20px;
      }

      .pagination button {
        background-color: #e0e0e0;
        border: none;
        padding: 8px 12px;
        margin: 0 5px;
        border-radius: 5px;
        cursor: pointer;
      }

      .pagination button.active {
        background-color: #2f6ea3;
        color: white;
      }

      th i {
        font-size: 20px;
      }

      /* Mobile responsiveness */
      @media screen and (max-width: 600px) {
        .filter-container {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-item input {
          width: 100%;
        }
      }

      /* ðŸ“± Mobile Responsive Styles */
      @media screen and (max-width: 768px) {
        .container {
          width: 95%;
          padding: 15px;
        }
        #toggle-filters {
          font-size: 14px;
          padding: 8px 12px;
        }

        h1 {
          font-size: 22px;
          padding: 15px;
        }

        input {
          width: 90%;
          font-size: 14px;
        }

        .filter-buttons button {
          padding: 8px 12px;
          font-size: 14px;
        }

        table {
          font-size: 14px;
          min-width: 500px;
        }

        th,
        td {
          padding: 10px;
        }

        .view-ncr {
          margin-right: 10px;
        }
      }

      @media screen and (max-width: 480px) {
        h1 {
          font-size: 20px;
        }
        #toggle-filters {
          font-size: 13px;
          padding: 6px 10px;
        }

        .filter-buttons button {
          font-size: 13px;
          padding: 6px 10px;
        }

        table {
          min-width: 400px;
          font-size: 13px;
        }

        input {
          font-size: 13px;
        }

        .view-ncr {
          margin-right: 10px;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <nav>
        <div class="navbar">
          <div>
            <a href="dashboard.html"
              ><img
                src="images/crossfire-logo-transparent.png"
                alt="Crossfire Logo"
                class="logo"
            /></a>
          </div>
          <div class="navbar-links">
            <ul>
              <li>
                <a href="dashboard.html"
                  ><i class="bi bi-house-fill"></i> Dashboard</a
                >
              </li>
              <li>
                <a href="view-ncr.html"
                  ><i
                    class="bi bi-file-earmark-bar-graph-fill"
                    style="font-weight: 900"
                  ></i>
                  NCR Log</a
                >
              </li>
              <li id="create-ncr-menu">
                <a href="create-ncr.html"
                  ><i class="bi bi-file-earmark-plus-fill"></i> Create NCR</a
                >
              </li>
              <li id="admin-panel">
                <a href="admin.html"
                  ><i class="bi bi-person-fill"></i>Admin Panel</a
                >
              </li>
            </ul>
          </div>
          <div class="navbar-icons">
            <div
              onclick="closePopUp()"
              title="Notifications"
              class="navbar-notification"
            >
              <i id="notification-icon" class="bi bi-bell-fill"></i>
              <div id="notification-indicator" class="notification-indicator">
                4
              </div>
            </div>
            <!-- User Profile Dropdown -->
            <div
              class="navbar-profile"
              onclick="toggleProfileMenu()"
              title="Profile"
            >
              <i class="bi bi-person-circle"></i>
              <span id="userName">User</span>
              <i class="bi bi-chevron-down"></i>
            </div>

            <!-- Profile Dropdown Menu -->
            <div id="profilePopup" class="profile-popup hidden">
              <div class="profile-header">
                <i class="bi bi-person-circle profile-icon"></i>
                <div>
                  <h4 id="profileName">User Name</h4>
                  <p id="profileDepartment">Department</p>
                </div>
              </div>
              <div class="profile-menu">
                <a href="profile.html" class="profile-menu-item">
                  <i class="bi bi-person"></i> My Profile
                </a>
                <!-- <a href="setting-mock.html" class="profile-menu-item">
                  <i class="bi bi-gear"></i> Settings
                </a> -->
                <hr class="profile-divider" />
                <a
                  href="index.html"
                  class="profile-menu-item"
                  onclick="logout()"
                >
                  <i class="bi bi-box-arrow-right"></i> Logout
                </a>
              </div>
            </div>

            <div onclick="toggleMenu()" title="Menu" class="navbar-menu">
              <i id="menu-icon"></i>
            </div>
          </div>
          <div
            id="notificationPopup"
            title="Notifications"
            class="notification-popup hidden"
          >
            <!-- Notifications -->
            <div>
              <h3 class="notification-title">Notifications</h3>
              <p id="no-notifications" class="no-notifications">
                No notifications yet
              </p>
              <ul class="notification-list"></ul>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <div id="wrapper">
      <h1>All NCRs</h1>

      <div class="container">
        <div class="filter-buttons">
          <button class="filter-btn active" data-status="all">All NCR</button>
          <button class="filter-btn" data-status="Active">Active</button>
          <button class="filter-btn" data-status="Closed">Closed</button>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
          "
        >
          <!-- Show Filters Button -->
          <button
            id="toggle-filters"
            data-bs-toggle="collapse"
            data-bs-target="#filtersBox"
            style="
              background-color: #2f6ea3;
              min-width: 150px;
              color: #fff;
              padding: 5px;
              border-radius: 8px;
              border: 1px solid #2f6ea3;
            "
          >
            Show Filters
          </button>

          <!-- Rows per page dropdown -->
          <div class="rows-per-page-container">
            <label for="rowsPerPageSelect" class="rows-per-page-label"
              >Rows per page:</label
            >
            <select id="rowsPerPageSelect" class="rows-per-page-select">
              <option value="5" selected>5</option>
              <option value="10">10</option>
              <option value="15">15</option>
              <option value="20">20</option>
            </select>
          </div>
        </div>

        <div id="filtersBox" class="collapse">
          <div
            class="p-4 rounded-3 shadow-sm"
            style="
              background: #f8f9fa;
              border: 1px solid #ddd;
              margin-bottom: 10px;
            "
          >
            <div class="row g-3">
              <div class="col-md-3">
                <label for="filter-ncr" class="form-label fw-semibold"
                  >NCR No:</label
                >
                <input
                  type="text"
                  id="filter-ncr"
                  placeholder="Filter by NCR No."
                  class="form-control border-secondary"
                />
              </div>

              <div class="col-md-3">
                <label for="filter-supplier" class="form-label fw-semibold"
                  >Supplier:</label
                >
                <input
                  type="text"
                  id="filter-supplier"
                  placeholder="Filter by Supplier"
                  class="form-control border-secondary"
                />
              </div>

              <div class="col-md-3">
                <label for="filter-start-date" class="form-label fw-semibold"
                  >Start Date:</label
                >
                <input
                  type="date"
                  id="filter-start-date"
                  class="form-control border-secondary"
                />
              </div>

              <div class="col-md-3">
                <label for="filter-end-date" class="form-label fw-semibold"
                  >End Date:</label
                >
                <input
                  type="date"
                  id="filter-end-date"
                  class="form-control border-secondary"
                />
              </div>
            </div>
            <button
              id="clear-filters"
              style="
                background-color: #2f6ea3;
                min-width: 150px;
                color: #fff;
                padding: 5px;
                margin-bottom: 10px;
                border-radius: 8px;
                border: 1px solid #2f6ea3;
              "
            >
              Clear Filters
            </button>
          </div>
        </div>

        <div class="table-container">
          <table id="ncrTable">
            <thead>
              <tr>
                <th onclick="sortTable(0)">
                  NCR No. <i class="bi bi-arrow-down-up"></i>
                </th>

                <th onclick="sortTable(2)">
                  Date Created <i class="bi bi-arrow-down-up"></i>
                </th>
                <th onclick="sortTable(3)">
                  Supplier <i class="bi bi-arrow-down-up"></i>
                </th>
                <th onclick="sortTable(1)">
                  Current Status <i class="bi bi-arrow-down-up"></i>
                </th>
                <th colspan="3">Action</th>
              </tr>
            </thead>
            <tbody id="ncrTableBody"></tbody>
          </table>
        </div>

        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="scripts/script.js"></script>
    <script src="scripts/data-manager.js"></script>
    <script src="scripts/user-manager.js"></script>

    <!-- 2. Shared navbar (depends on UserManager) -->
    <script src="scripts/navbar.js"></script>
    <!-- 3. Other shared utilities -->
    <script src="scripts/notifications.js"></script>
    <script src="scripts/user-conditions.js"></script>

    <script>
      let ncrData = [];
      let filteredData = [];
      let currentPage = 1;

      let sortColumn = -1;
      let sortAsc = true;
      let users = [];

      // Load users data
      fetch("data/users.json")
        .then((response) => response.json())
        .then((userData) => {
          const storedUsers = localStorage.getItem("users");

          // Use localStorage users if available, otherwise use JSON file
          if (storedUsers) {
            try {
              users = JSON.parse(storedUsers);
            } catch (e) {
              console.error(
                "Invalid users localStorage data â€“ using JSON file.",
                e
              );
              users = userData;
            }
          } else {
            users = userData; // fallback to JSON file
            // Optionally save to localStorage for future use
            localStorage.setItem("users", JSON.stringify(userData));
          }

          console.log("Users loaded:", users);

          //load NCR data
          return fetch("data/logData.json");
        })
        .then((response) => response.json())
        .then((data) => {
          const records = localStorage.getItem("ncr_records");

          if (records) {
            try {
              ncrData = JSON.parse(records);
            } catch (e) {
              console.error("Invalid NCR localStorage data â€“ resetting.", e);
              ncrData = data;
            }
          } else {
            ncrData = data;
          }

          filteredData = [...ncrData];
          renderTable();
        })
        .catch((error) => console.error("Error loading data:", error));
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      let rowsPerPage = 5; // default

      // Update rows per page when user selects
      document
        .getElementById("rowsPerPageSelect")
        .addEventListener("change", function () {
          rowsPerPage = Number(this.value);
          currentPage = 1; // reset to first page
          renderTable();
        });

      function renderTable() {
        const tableBody = document.getElementById("ncrTableBody");
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredData.slice(start, end);

        tableBody.innerHTML = "";

        pageData.forEach((item) => {
          const formattedDate = formatDate(item.dateCreated);

          // Determine buttons based on status
          let actionButtons = `
            <td class="action-cell">
              <a href="detailedViewNCR.html?ncr=${
                item.ncrNumber
              }" class="view-ncr">View</a>
              ${
                item.status === "Closed"
                  ? `<button class="generate-pdf-btn" onclick='generateSinglePDF("${item.ncrId}")'>PDF</button>`
                  : `<a href="edit-ncr.html" onClick="selectedLog('${item.ncrNumber}')" class="view-ncr">Edit</a>`
              }
            </td>
          `;

          const row = `
            <tr>
              <td>${item.ncrNumber}</td>
              <td>${formattedDate}</td>
              <td>${item.supplierName}</td>
              <td>${item.status}</td>
              ${actionButtons}
            </tr>
          `;

          tableBody.innerHTML += row;
        });

        renderPagination();
      }

      function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
          pagination.innerHTML += `<button class="${
            i === currentPage ? "active" : ""
          }" onclick="goToPage(${i})">${i}</button>`;
        }
      }

      function goToPage(page) {
        currentPage = page;
        renderTable();
      }

      // Search
      const toggleBtn = document.getElementById("toggle-filters");
      const filtersBox = document.getElementById("filtersBox");

      // When collapse is shown
      filtersBox.addEventListener("shown.bs.collapse", () => {
        toggleBtn.textContent = "Hide Filters";
      });

      // When collapse is hidden
      filtersBox.addEventListener("hidden.bs.collapse", () => {
        toggleBtn.textContent = "Show Filters";
      });

      function applyFilters() {
        const ncrQuery = document
          .getElementById("filter-ncr")
          .value.toLowerCase();
        const supplierQuery = document
          .getElementById("filter-supplier")
          .value.toLowerCase();
        const startDate = document.getElementById("filter-start-date").value;
        const endDate = document.getElementById("filter-end-date").value;

        filteredData = ncrData.filter((item) => {
          const itemDate = new Date(item.dateCreated);
          // Only take the date part (ignore time)
          const itemDateOnly = new Date(
            itemDate.getFullYear(),
            itemDate.getMonth(),
            itemDate.getDate()
          );

          const matchesNCR = item.ncrNumber.toLowerCase().includes(ncrQuery);
          const matchesSupplier = item.supplierName
            .toLowerCase()
            .includes(supplierQuery);

          let matchesStart = true;
          let matchesEnd = true;

          if (startDate) {
            const start = new Date(startDate);
            matchesStart = itemDateOnly >= start;
          }
          if (endDate) {
            const end = new Date(endDate);
            end.setDate(end.getDate() + 1);
            matchesEnd = itemDateOnly <= end;
          }

          return matchesNCR && matchesSupplier && matchesStart && matchesEnd;
        });

        currentPage = 1;
        renderTable();
      }
      document
        .getElementById("filter-ncr")
        .addEventListener("input", applyFilters);
      document
        .getElementById("filter-supplier")
        .addEventListener("input", applyFilters);
      document
        .getElementById("filter-start-date")
        .addEventListener("change", applyFilters);
      document
        .getElementById("filter-end-date")
        .addEventListener("change", applyFilters);

      // Filter buttons
      document.querySelectorAll(".filter-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const status = btn.dataset.status;
          filteredData =
            status === "all"
              ? [...ncrData]
              : ncrData.filter((item) => item.status === status);
          currentPage = 1;
          renderTable();
        })
      );

      //Clear filter
      document.getElementById("clear-filters").addEventListener("click", () => {
        // Clear all filter inputs
        document.getElementById("filter-ncr").value = "";
        document.getElementById("filter-supplier").value = "";
        document.getElementById("filter-start-date").value = "";
        document.getElementById("filter-end-date").value = "";

        // Reset filtered data
        filteredData = [...ncrData];
        currentPage = 1;
        renderTable();

        // Reset filter buttons
        document
          .querySelectorAll(".filter-btn")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelector('.filter-btn[data-status="all"]')
          .classList.add("active");
      });

      // Sorting
      function sortTable(colIndex) {
        const keys = [
          "ncrNumber",
          "currentStage",
          "dateCreated",
          "supplierName",
        ];
        if (sortColumn === colIndex) sortAsc = !sortAsc;
        else sortAsc = true;
        sortColumn = colIndex;

        filteredData.sort((a, b) => {
          const valA = a[keys[colIndex]].toLowerCase();
          const valB = b[keys[colIndex]].toLowerCase();
          return (valA > valB ? 1 : valA < valB ? -1 : 0) * (sortAsc ? 1 : -1);
        });
        renderTable();
      }

      doc.setProperties({ scale: 1 });

      function generateSinglePDF(ncrId) {
        const ncr = ncrData.find((n) => n.ncrId === Number(ncrId));

        if (!ncr) {
          alert("NCR not found!");
          return;
        }

        // Get user details
        const creator = users.find(
          (u) => Number(u.userId) === Number(ncr.createdBy)
        );
        const creatorName = creator
          ? `${creator.firstName} ${creator.lastName}`
          : "Unknown";
        const creatorEmail = creator ? creator.email : "N/A";

        const inspector = users.find(
          (u) => Number(u.userId) === Number(ncr.quality.inspectorId)
        );
        const inspectorName = inspector
          ? `${inspector.firstName} ${inspector.lastName}`
          : "Unknown";

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const logo = "images/crossfire-logo-transparent.png";

        // Softer, more professional color scheme
        const primaryColor = [88, 151, 201]; // Light blue #5897c9 (CrossFire brand)
        const darkPrimary = [70, 120, 160]; // Darker shade of blue
        const accentColor = [22, 52, 81]; // Dark blue #163451 for accents
        const secondaryColor = [100, 116, 139]; // Softer slate gray
        const lightGray = [248, 249, 250]; // Very light gray
        const mediumGray = [241, 243, 245]; // Softer medium gray
        const darkGray = [100, 116, 139]; // Softer dark gray
        const successColor = [52, 168, 83]; // Softer green
        const warningColor = [251, 188, 5]; // Softer amber
        const dangerColor = [234, 67, 53]; // Softer red
        const infoColor = [66, 165, 245]; // Softer cyan

        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        const contentWidth = pageWidth - 2 * margin;

        function addSectionHeader(text, yPosition) {
          // Single light blue background
          doc.setFillColor(220, 235, 245); // Light blue
          doc.rect(margin, yPosition, contentWidth, 11, "F");

          // Add dark blue accent bar on left
          doc.setFillColor(...primaryColor);
          doc.rect(margin, yPosition, 4, 11, "F");

          // Text
          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.setTextColor(...accentColor);
          doc.text(text, margin + 10, yPosition + 7.5);
          doc.setTextColor(0, 0, 0);

          return yPosition + 17;
        }

        // Enhanced two-column layout with larger text and better spacing
        function addTwoColumnRow(label1, value1, label2, value2, yPosition) {
          // Single grey background container
          doc.setFillColor(245, 245, 245); // Light grey
          doc.rect(margin, yPosition - 4, contentWidth, 11, "F");

          // Labels
          doc.setFontSize(9);
          doc.setFont(undefined, "bold");
          doc.setTextColor(...darkGray);
          doc.text(label1.toUpperCase(), margin + 4, yPosition);
          if (label2)
            doc.text(
              label2.toUpperCase(),
              margin + contentWidth / 2 + 4,
              yPosition
            );

          // Values
          doc.setFontSize(11);
          doc.setFont(undefined, "normal");
          doc.setTextColor(0, 0, 0);
          doc.text(String(value1), margin + 4, yPosition + 6);
          if (value2)
            doc.text(
              String(value2),
              margin + contentWidth / 2 + 4,
              yPosition + 6
            );

          return yPosition + 14;
        }

        // Enhanced wrapped text with larger font and better spacing
        function addWrappedText(
          label,
          value,
          yPosition,
          maxWidth = contentWidth - 12
        ) {
          // Label
          doc.setFontSize(9);
          doc.setFont(undefined, "bold");
          doc.setTextColor(...darkGray);
          doc.text(label.toUpperCase(), margin + 4, yPosition);
          yPosition += 6;

          // Single grey background container
          doc.setFillColor(245, 245, 245); // Light grey
          const wrappedText = doc.splitTextToSize(String(value), maxWidth);
          const boxHeight = wrappedText.length * 6 + 6;
          doc.rect(margin, yPosition - 2, contentWidth, boxHeight, "F");

          doc.setFontSize(10);
          doc.setFont(undefined, "normal");
          doc.setTextColor(0, 0, 0);
          doc.text(wrappedText, margin + 4, yPosition + 3);

          return yPosition + boxHeight + 6;
        }
        // Modern info box with softer colors and larger text
        function addInfoBox(
          label,
          value,
          x,
          y,
          width,
          height,
          bgColor = mediumGray
        ) {
          // Shadow effect (softer)
          doc.setFillColor(220, 220, 220);
          doc.roundedRect(x + 0.3, y + 0.3, width, height, 2, 2, "F");

          // Main box
          doc.setFillColor(...bgColor);
          doc.roundedRect(x, y, width, height, 2, 2, "F");

          // Border (softer)
          doc.setDrawColor(...primaryColor);
          doc.setLineWidth(0.2);
          doc.roundedRect(x, y, width, height, 2, 2, "S");

          doc.setFontSize(8);
          doc.setFont(undefined, "bold");
          doc.setTextColor(...darkGray);
          doc.text(label.toUpperCase(), x + 3, y + 5);

          doc.setFontSize(12);
          doc.setFont(undefined, "bold");
          doc.setTextColor(...darkPrimary);
          doc.text(String(value), x + 3, y + 13);
          doc.setTextColor(0, 0, 0);
        }

        // ==================== LIGHTER PROFESSIONAL HEADER ====================
        // Light gradient header background (much lighter so logo shows clearly)
        // doc.setFillColor(245, 248, 252);  // Very light blue-gray
        // doc.rect(0, 0, pageWidth, 45, "F");

        // // Gradient effect (top to bottom) - subtle
        // doc.setFillColor(235, 242, 250);
        // doc.rect(0, 10, pageWidth, 35, "F");

        // doc.setFillColor(225, 235, 245);
        // doc.rect(0, 25, pageWidth, 20, "F");

        // // Add accent stripe at top (CrossFire blue)
        // doc.setFillColor(...primaryColor);
        // doc.rect(0, 0, pageWidth, 3, "F");

        // // Bottom border for header
        // doc.setDrawColor(...primaryColor);
        // doc.setLineWidth(0.5);
        // doc.line(0, 45, pageWidth, 45);
        doc.setFillColor(220, 235, 245); // Light blue
        doc.rect(0, 0, pageWidth, 45, "F");

        // Add darker blue stripe at top
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, pageWidth, 3, "F");

        // Bottom border
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(0.8);
        doc.line(0, 45, pageWidth, 45);

        // Logo with FIXED aspect ratio (884:207 = 4.27:1)
        const logoX = margin;
        const logoWidth = 60; // Slightly larger for better visibility
        const logoAspectRatio = 4.27;
        const logoHeight = logoWidth / logoAspectRatio; // = 14

        const logoImg = new Image();
        logoImg.src = logo;
        doc.addImage(logoImg, "PNG", logoX, 14, logoWidth, logoHeight);

        // Title with better typography (dark text on light background)
        doc.setFontSize(18);
        doc.setFont(undefined, "bold");
        doc.setTextColor(...accentColor);
        doc.text("NON-CONFORMANCE REPORT", pageWidth - margin, 20, {
          align: "right",
        });

        // NCR Number with brand color
        doc.setFontSize(14); // Was 12, now 14 (bigger)
        doc.setFont(undefined, "bold");
        doc.setTextColor(...accentColor); // Was primaryColor (light blue), now accentColor (dark blue)
        doc.text(`NCR #${ncr.ncrNumber}`, pageWidth - margin, 29, {
          align: "right",
        });

        let yPos = 55;

        // Professional status badge with softer colors
        const statusBgColor =
          ncr.status === "Closed" ? successColor : infoColor;
        const statusText = ncr.status.toUpperCase();

        // Status badge background
        doc.setFillColor(...statusBgColor);
        doc.roundedRect(margin, yPos, 40, 10, 2, 2, "F");

        doc.setFontSize(10);
        doc.setFont(undefined, "bold");
        doc.setTextColor(255, 255, 255);
        doc.text(statusText, margin + 20, yPos + 6.5, { align: "center" });

        // Current stage info on right with better spacing
        doc.setFontSize(10);
        doc.setFont(undefined, "normal");
        doc.setTextColor(...darkGray);

        yPos += 18;

        // Supplier Information Card with softer styling
        // Supplier Information Card - single grey background
        doc.setFillColor(245, 245, 245); // Light grey
        doc.roundedRect(margin, yPos, contentWidth, 22, 2, 2, "F");
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(0.3);
        doc.roundedRect(margin, yPos, contentWidth, 22, 2, 2, "S");

        doc.setFontSize(9);
        doc.setFont(undefined, "bold");
        doc.setTextColor(...darkGray);
        doc.text("SUPPLIER INFORMATION", margin + 4, yPos + 6);

        doc.setFontSize(12);
        doc.setFont(undefined, "bold");
        doc.setTextColor(...darkPrimary);
        doc.text(ncr.supplierName || "N/A", margin + 4, yPos + 13);

        doc.setFontSize(9);
        doc.setFont(undefined, "normal");
        doc.setTextColor(...darkGray);

        yPos += 28;

        // ==================== GENERAL INFORMATION ====================
        yPos = addSectionHeader("GENERAL INFORMATION", yPos);

        yPos = addTwoColumnRow(
          "Created By:",
          creatorName,
          "Email:",
          creatorEmail,
          yPos
        );
        yPos = addTwoColumnRow(
          "Date Created:",
          formatDate(ncr.dateCreated),
          "Last Updated:",
          formatDate(ncr.lastUpdated),
          yPos
        );

        yPos += 5;

        // ==================== QUALITY INSPECTION ====================
        yPos = addSectionHeader("QUALITY INSPECTION", yPos);

        yPos = addTwoColumnRow(
          "PO Number:",
          ncr.quality.poNumber,
          "SO Number:",
          ncr.quality.salesOrderNumber,
          yPos
        );
        yPos = addTwoColumnRow(
          "Inspection Date:",
          formatDate(ncr.quality.inspectionDate),
          "Inspector:",
          inspectorName,
          yPos
        );
        yPos = addWrappedText(
          "Item Description:",
          ncr.quality.itemDescription,
          yPos
        );

        yPos += 5;

        // Professional quantity info cards
        const cardWidth = (contentWidth - 9) / 4;
        addInfoBox(
          "Qty Received",
          ncr.quality.quantityReceived,
          margin,
          yPos,
          cardWidth,
          16
        );
        addInfoBox(
          "Qty Defective",
          ncr.quality.quantityDefective,
          margin + cardWidth + 3,
          yPos,
          cardWidth,
          16
        );
        addInfoBox(
          "Non-Conforming",
          ncr.quality.itemMarkedNonconforming ? "YES" : "NO",
          margin + (cardWidth + 3) * 2,
          yPos,
          cardWidth,
          16,
          ncr.quality.itemMarkedNonconforming ? [255, 243, 224] : mediumGray
        );
        addInfoBox(
          "Eng. Required",
          ncr.quality.engineeringRequired ? "YES" : "NO",
          margin + (cardWidth + 3) * 3,
          yPos,
          cardWidth,
          16,
          ncr.quality.engineeringRequired ? [255, 243, 224] : mediumGray
        );

        yPos += 23;

        // Professional defect description alert box with softer colors
        const defectDesc = doc.splitTextToSize(
          ncr.quality.defectDescription,
          contentWidth - 16
        );
        const defectBoxHeight = Math.max(26, defectDesc.length * 6 + 14);

        // Shadow (softer)
        doc.setFillColor(230, 230, 230);
        doc.roundedRect(
          margin + 0.2,
          yPos + 0.2,
          contentWidth,
          defectBoxHeight,
          2,
          2,
          "F"
        );

        // Main box with softer warning color
        doc.setFillColor(255, 250, 240);
        doc.roundedRect(margin, yPos, contentWidth, defectBoxHeight, 2, 2, "F");

        // Left accent bar (softer red)
        doc.setFillColor(...dangerColor);
        doc.roundedRect(margin, yPos, 4, defectBoxHeight, 2, 2, "F");

        // Border (softer)
        doc.setDrawColor(...dangerColor);
        doc.setLineWidth(0.3);
        doc.roundedRect(margin, yPos, contentWidth, defectBoxHeight, 2, 2, "S");

        // Label with larger font
        doc.setFontSize(10);
        doc.setFont(undefined, "bold");
        doc.setTextColor(...dangerColor);
        doc.text("âš   DEFECT DESCRIPTION", margin + 8, yPos + 7);

        // Description text with larger font
        doc.setFontSize(10);
        doc.setFont(undefined, "normal");
        doc.setTextColor(0, 0, 0);
        doc.text(defectDesc, margin + 8, yPos + 17);

        yPos += defectBoxHeight + 10;

        // ==================== ENGINEERING DISPOSITION ====================
        if (ncr.engineering && ncr.engineering.engineerId) {
          if (yPos > 245) {
            doc.addPage();
            yPos = 20;
          }

          yPos = addSectionHeader("ENGINEERING DISPOSITION", yPos);

          const engineer = users.find(
            (u) => Number(u.userId) === Number(ncr.engineering.engineerId)
          );
          const engineerName = engineer
            ? `${engineer.firstName} ${engineer.lastName}`
            : "Unknown";

          yPos = addTwoColumnRow(
            "Engineer:",
            engineerName,
            "Disposition Type:",
            ncr.engineering.dispositionType || "N/A",
            yPos
          );
          yPos = addTwoColumnRow(
            "Disposition Date:",
            formatDate(ncr.engineering.dispositionDate),
            "Completed:",
            ncr.engineering.completed ? "YES" : "NO",
            yPos
          );
          yPos = addTwoColumnRow(
            "Original Rev:",
            ncr.engineering.originalRevNumber || "N/A",
            "Updated Rev:",
            ncr.engineering.updatedRevNumber || "N/A",
            yPos
          );
          yPos = addTwoColumnRow(
            "Drawing Update:",
            ncr.engineering.drawingUpdateRequired ? "YES" : "NO",
            "Revision Date:",
            formatDate(ncr.engineering.revisionDate),
            yPos
          );

          if (ncr.engineering.dispositionDetails) {
            yPos += 2;
            yPos = addWrappedText(
              "Disposition Details:",
              ncr.engineering.dispositionDetails,
              yPos
            );
          }

          yPos += 5;
        }

        // ==================== OPERATIONS ====================
        if (ncr.operations && ncr.operations.operationsManagerId) {
          if (yPos > 245) {
            doc.addPage();
            yPos = 20;
          }

          yPos = addSectionHeader("OPERATIONS", yPos);

          const opsManager = users.find(
            (u) =>
              Number(u.userId) === Number(ncr.operations.operationsManagerId)
          );
          const opsManagerName = opsManager
            ? `${opsManager.firstName} ${opsManager.lastName}`
            : "Unknown";

          yPos = addTwoColumnRow(
            "Operations Manager:",
            opsManagerName,
            "Action Date:",
            formatDate(ncr.operations.actionDate),
            yPos
          );
          yPos = addTwoColumnRow(
            "CAR Required:",
            ncr.operations.carRequired ? "YES" : "NO",
            "CAR Number:",
            ncr.operations.carNumber || "N/A",
            yPos
          );
          yPos = addTwoColumnRow(
            "Completed:",
            ncr.operations.completed ? "YES" : "NO",
            "Completed At:",
            ncr.operations.completedAt
              ? formatDate(ncr.operations.completedAt)
              : "N/A",
            yPos
          );

          yPos += 2;
          yPos = addWrappedText(
            "Action Taken:",
            ncr.operations.actionTaken || "N/A",
            yPos
          );

          yPos += 5;
        }

        // ==================== PROCUREMENT ====================
        if (ncr.procurement && ncr.procurement.buyerId) {
          if (yPos > 245) {
            doc.addPage();
            yPos = 20;
          }

          yPos = addSectionHeader("PROCUREMENT", yPos);

          const buyer = users.find(
            (u) => Number(u.userId) === Number(ncr.procurement.buyerId)
          );
          const buyerName = buyer
            ? `${buyer.firstName} ${buyer.lastName}`
            : "Unknown";

          yPos = addTwoColumnRow(
            "Buyer:",
            buyerName,
            "SAP Completed:",
            ncr.procurement.sapCompleted ? "YES" : "NO",
            yPos
          );
          yPos = addTwoColumnRow(
            "Supplier Return:",
            ncr.procurement.supplierReturn ? "YES" : "NO",
            "Dispose On Site:",
            ncr.procurement.disposeOnSite ? "YES" : "NO",
            yPos
          );
          yPos = addTwoColumnRow(
            "Credit Expected:",
            ncr.procurement.creditExpected ? "YES" : "NO",
            "Billing Supplier:",
            ncr.procurement.billingSupplier ? "YES" : "NO",
            yPos
          );
          yPos = addTwoColumnRow(
            "RMA Number:",
            ncr.procurement.rmaNumber || "N/A",
            "Carrier Account:",
            ncr.procurement.carrierAccount || "N/A",
            yPos
          );

          if (ncr.procurement.replacementDate) {
            yPos = addTwoColumnRow(
              "Replacement Date:",
              formatDate(ncr.procurement.replacementDate),
              "",
              "",
              yPos
            );
          }

          yPos += 5;
        }

        // ==================== CLOSURE INFORMATION ====================
        if (ncr.status === "Closed") {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }

          yPos = addSectionHeader("CLOSURE INFORMATION", yPos);

          const closedByUser = users.find(
            (u) => Number(u.userId) === Number(ncr.closedBy)
          );
          const closedByName = closedByUser
            ? `${closedByUser.firstName} ${closedByUser.lastName}`
            : "Unknown";

          yPos = addTwoColumnRow(
            "Closed By:",
            closedByName,
            "Date Closed:",
            formatDate(ncr.dateClosed),
            yPos
          );
        }

        // ==================== PROFESSIONAL FOOTER ====================
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);

          // Footer accent bar (softer)
          doc.setFillColor(...primaryColor);
          doc.rect(0, 283, pageWidth, 2, "F");

          // Footer background (very light)
          doc.setFillColor(252, 252, 252);
          doc.rect(0, 285, pageWidth, 12, "F");

          // Footer content with larger text
          doc.setFontSize(8);
          doc.setTextColor(...darkGray);
          doc.setFont(undefined, "normal");
          doc.text(
            `Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`,
            margin,
            291
          );

          // Page number with accent
          doc.setFont(undefined, "bold");
          doc.setTextColor(...darkPrimary);
          doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, 291, {
            align: "right",
          });

          // Company name in center
          doc.setFont(undefined, "italic");
          doc.setTextColor(...darkGray);
          doc.text("CrossFire Welding Systems", pageWidth / 2, 291, {
            align: "center",
          });
        }

        // Save PDF
        doc.save(`NCR_${ncr.ncrNumber}_Report.pdf`);
      }
    </script>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</html>
